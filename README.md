# 同济大学软件学院操作系统课程项目——文件管理


## 1.项目简介

在内存中开辟一个空间作为文件存储器，在其上实现一个简单的文件系统; 退出这个文件系统时，需要该文件系统的内容保存到磁盘上，以便下次可以将其回复到内存中来。基本要求如下:

- 文件存储空间管理可采取显式链接（如FAT）或者其他方法。
- 空闲空间管理可采用位图或者其他方法。如果采用了位图，可将位图和FAT表合二为一。
- 文件目录采用多级目录结构。至于是否采用索引节点结构，自选。目录项目中应包含：文件名、物理地址、长度等信息，也可增加一些其他信息。
- 能提供格式化、创建子目录、删除子目录、显示目录、更改当前目录、创建文件、打开文件、关闭文件、写文件、读文件、删除文件等操作
- 有基本的用户界面

## 2.开发环境与项目结构

- 开发工具:

  1.Visual Studio Code 2019

  2.PyCharm Community Edition 2020.1.3 x64 (Qt Designer,PyUIC5 as External Tools)

- 开发语言:  Python3

- 所使用的库:

  PyQt5 (使用Qt为前端框架，PyQt5为支持python3的Qt版本框架)

- 项目文件结构:

  *utils.py*: 自定义工具声明(QSS读取器等)

  *memory.py*: 读写内存方法

  *mainwindow.py*: 窗体设计源码,由PyUIC5根据Qt Designer的UI设计文件生成

  *mainwindow.ui*: 窗体设计,Qt Designer的UI设计文件生成

  *file-management.py*: 主函数，以及文件管理系统的运行逻辑

  *resources*:包含该项目所有的图片(.png)，可执行文件图标(.ico)

  *style*:用于界面美化的样式文件

  *main.exe* 可执行文件，**运行时需要与style,resources文件夹相同目录**

## 3.功能简介

### 界面说明与功能描述:

![img](https://gitee.com/mount-potato/markdown-img-hosting/raw/master/pic/20210624175917.png)

项目主界面见上，实现的功能主要有：

- 文件的创建，读写，删除，编辑，保存，信息的查看（最近修改时间，文件类型，文件大小，文件名）
- 文件夹的创建，删除(文件级联)，编辑，重命名，查看信息 （最近修改时间，文件类型，文件名）
- 多级目录，上下级目录的切换(通过右键点击实现打开文件夹，通过return返回上级目录)
- 多种文件目录视图，包括文件目录树形视图以及当前目录视图
- 格式化，以及保存当前文件系统于本地文件中

## 4.文件系统管理方法描述

本项目采用多级目录结构的文件目录设计，对空闲空间采用位图法的方式。

在默认打开时，通过在项目同目录下生成一个 `root.txt` 文件，实现文件管理空间的开辟，该文件大小为32MB，模拟一个$32MB $（$32768 KB$）的文件管理的内存空间。

我们使用python中的 *byte* 方法设置字节串，以 utf-8 为编码，并设1KB为一个字节串的默认可支配大小，这样就形成了32768个字节串。设前4个字节串为空闲的空间位图；第5个为根目录的起始块，之后的则都是目前该系统所含有的空闲空间。

对于本文件管理系统，所设计的目录列表是含有4个子列表的列表结构，4个子列表分别为:

- `str_info` : 存储该目录下所有子文件的名字，这些名字组成一个列表，其中第一个名字固定为`Parent/` 表示返回上级
- `loc_info` : 每个子文件所存储在的块号，块号组成一个列表（默认为0，实际操作时从根目录默认块4开始) 
- `size_info` : 每个子文件的大小，大小值组成一个列表（文件夹为0，txt文件大小单位为字节B)
- `type_info` : 每个子文件的类型，类型的标识符组成一个列表（文件夹为0，文件为1，编程时用常量变量代替）

文件的创建读写等操作总是包括对文件目录表的改写，在这个过程中，涉及文件目录表与字符串之间的转换。

例如：在打开文件夹时，对形如`[['Parent\n', 'new file', 'new folder'], [0, 5, 6], [0, 0, 0], [1, 0, 1]]` 的文件夹 （即，含有一个叫new file的txt文件，一个叫new folder的文件夹的目录），调用` dir_list_to_str ` 函数将其转换为 `b'Parent\n\xff\x00\x00\x00\x00\x00\x01\xffnew file\xff\x00\x05\x00\x00\x00\x00\xffnew folder\xff\x00\x06\x00\x00\x00\x01\xff'` 的串，从而以串的形式参与该目录下文件更改时对应目录信息的更改，并通过程序中自定义的读写函数对位图列表`self.bitmap_list`进行修改。

同样的道理，我们也可调用`dir_str_to_list` 将该串信息转换为python支持的目录列表，这一函数主要在要切换目录时进行调用。

在以上的基础结构之下，系统实现了以下的方法(命名遵循qt触发函数命名规范，表示按钮触发):

(注：table控件为当前目录下所有文件与文件夹的视图)

|              方法              |                           实现细节                           |
| :----------------------------: | :----------------------------------------------------------: |
|  **on_new_file_btn_clicked**   | 新建文件。以扫描table控件中所有文件名设置默认新建名，在位图列表中开辟一个新空间，并把新的目录列表信息以串的形式写入位图列表中 |
| **on_new_folder_btn_clicked**  | 新建文件夹。以扫描table控件中所有文件夹名设置默认新建名，在位图列表中开辟一个新空间，并把新建的目录列表信息以串的形式写入位图列表中 |
|   **on_format_btn_clicked**    | 格式化。即重设了位图列表，通过原始初始化操作（见上）实现清空 |
|  **on_save_exit_btn_clicked**  |        保存并退出。将当前的位图列表全部写入root.txt中        |
|   **on_return_btn_clicked**    | 返回上级目录。清空table控件，路径列表回退一级后（即上级目录），将新的路径下读到的目录节点以列表形式返回，并根据这个列表更新table控件获取目录列表下的所有文件 |
|    **on_save_btn_clicked**     | 保存(txt)文件。将txt文档内容写入位图列表中对应的目录节点，并读取文件列表中对应的文件大小，在table控件中更新文件大小信息 |
|  **on_open_action_triggered**  | 打开操作(文件与文件夹)。对文件，在目录列表中根据文件名（同目录下文件名唯一）找到文件节点，激活输入框；对文件夹，在位图列表中读到下一级目录节点，并以列表形式返回从而对table控件更新 |
| **on_rename_action_triggered** | 重命名操作。将新名字内容写入位图列表中对应的目录节点，并读取文件列表中对应的名字，在table控件中更新文件名字 |
| **on_delete_action_triggered** |           删除操作。删除，涉及子文件夹递归删除操作           |
|      **update_tree_view**      |         更新树的视图。新建与删除时调用，涉及递归更新         |



## 5.运行截图与部分功能展示

### 用户界面

<img src="https://gitee.com/mount-potato/markdown-img-hosting/raw/master/pic/20210624180805.png" alt="img" style="zoom: 50%;" />

<img src="https://gitee.com/mount-potato/markdown-img-hosting/raw/master/pic/20210624181149.png" alt="img" style="zoom: 50%;" />



（主界面已于功能简介中用于说明展示，已包含文件修改展示，此处不再重复放出）

上：重命名文件功能展示

下:   新建文件展示（默认新建文件名随已有默认名文件而更新）

### 说明

用户可在界面下方选择`new file`或`new directory`，系统将根据已有文件或文件夹名字自动更新默认文件名；左侧的树状视图可以显示根目录下已有的文件目录组织，中间显示当前目录下所含有的文件与文件夹。当用户右键点击文件时，可选择打开操作(打开文件夹显示子文件、或打开文件进行编辑)，重命名操作与删除操作(删除文件夹时会导致该文件夹下子目录的级联删除)。用户可选择格式化清空当前的所有文件，而当用户点击“保存并退出”时，系统将当前文件组织写入`root.txt`中，在下次打开时重新加载，实现保存的功能。

## 6.项目总结

### 6.1 项目亮点

- 界面较为精美，使用说明较清楚
- 可在新建文件夹或文件时更新默认名字(如 new folder, new folder 1, new folder2 ,...)
- 仿照windows文件管理的实时文件信息显示（修改日期，文件类型，文件大小）

### 6.2 项目待改进之处

- 存储机制：本项目采用txt文件存储位图信息与加载已存储的文件内容，由于txt可改动性强，可能通过误改动的方式使原始位图信息受到影响
- 树形目录：由于时间与开发精力有限，树形目录只起到了展示的作用，没能做到在树形目录跳转
- 人性化操作： 暂时只支持右键点击文件或文件夹进行打开、重命名、删除操作，暂不支持双击打开操作，有待改进

### 6.3 项目收获

- 对文件管理有了更为直观深入的理解
- 通过位图设计对二进制文件相关知识有了更好的理解
- 熟悉了Python与Qt结合的前端设计框架
